;/*FB_PKG_DELIM*/

__d("LSHandleFTSIndexMessageResponse",["LSArrayGetObjectAt","LSDecryptMessages","LSIsEncryptionVersionSecure","LSIssueNewTask","LSLogMebClientEvent.nop","LSRestoreEchoBlobs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleFTSIndexMessageResponse] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.i64.neq(a[4],void 0)?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[15]=new c.Map(),d[15].set("error_msg","Expected a nonempty query result"),d[15].set("code",c.i64.cast([0,3])),d[15].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[16]=c.createArray(),d[17]=(d[16].push(d[15]),d[16]),e=[void 0,d[16]],d[9]=e[0],d[10]=e[1],e):(b=a.item,d[15]=new c.Map(),d[15].set("backup_id",b.backupId),d[15].set("device_public_key_blob",b.devicePublicKeyBlob),d[15].set("device_private_key_blob",b.devicePrivateKeyBlob),d[15].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[15].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[15].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[15].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[15].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[15].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[15].set("orf_client_state_v2_blob",void 0),d[15].set("orf_v2_authority_level",void 0),d[15].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[15].set("device_id",b.deviceId),d[15].set("backup_tenancy",b.backupTenancy),d[15].set("encryption_version",b.encryptionVersion),d[15].set("revision_version",b.revisionVersion),d[15].set("initialize_restore_result",void 0),d[15].set("authority_level",b.authorityLevel),e=[d[15],void 0],d[9]=e[0],d[10]=e[1],e)})},function(e){return d[12]=new c.Map(),d[12].set("value",d[9]),d[12].set("errors",d[10]),d[13]=d[12].get("value"),d[13]!==void 0?c.sequence([function(e){return d[15]=d[13].get("backup_id"),d[16]=d[13].get("device_public_key_blob"),d[17]=d[13].get("device_private_key_blob"),d[18]=d[13].get("epoch_storage_public_key_blob"),d[19]=d[13].get("epoch_storage_private_key_blob"),d[20]=d[13].get("epoch_auth_public_key_blob"),d[21]=d[13].get("epoch_auth_private_key_blob"),d[22]=d[13].get("mailbox_root_key_blob"),d[23]=d[13].get("ocmf_client_state_blob"),d[24]=d[13].get("orf_client_state_v2_blob"),d[25]=d[13].get("orf_v2_authority_level"),d[26]=d[13].get("oblivious_validation_token_blob"),d[27]=d[13].get("device_id"),d[28]=d[13].get("backup_tenancy"),d[29]=d[13].get("encryption_version"),d[30]=d[13].get("revision_version"),d[31]=d[13].get("initialize_restore_result"),d[32]=d[13].get("authority_level"),c.i64.neq(d[27],void 0)?c.sequence([function(a){return d[34]=void 0,c.i64.neq(d[34],void 0)?c.resolve(d[35]=d[34]):c.sequence([function(a){return d[38]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[39]?d[48]=(d[38].push(c.i64.cast([0,0])),d[38]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[40]=a[0],a})},function(a){return d[40]?d[48]=(d[38].push(c.i64.cast([0,2])),d[38]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[41]=a[0],a})},function(a){return d[41]?d[48]=(d[38].push(c.i64.cast([0,3])),d[38]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[48]=(d[38].push(c.i64.cast([0,4])),d[38]):0,d[43]=c.createArray(),d[44]=c.i64.of_int32(d[38].length),c.i64.gt(d[44],c.i64.cast([0,0]))?c.loopAsync(d[44],function(a){return d[48]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[38],d[48]).then(function(a){return a=a,d[49]=a[0],d[50]=a[1],a})},function(a){return d[51]=(d[43].push(d[49]),d[43])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[48]=c.createArray(),d[49]=c.i64.of_int32(d[43].length),c.i64.gt(d[49],c.i64.cast([0,0]))?c.loopAsync(d[49],function(a){return d[51]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[43],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[54]=(d[48].push(c.i64.to_string(d[52])),d[48])}])}):c.resolve()},function(a){return d[50]=d[48].join(","),d[45]=d[50]}])},function(a){return d[43].some(function(a){return c.i64.eq(d[29],a)})?d[46]=d[29]:d[46]=void 0,c.i64.neq(d[46],void 0)?d[47]=d[46]:d[47]=void 0,d[35]=d[47]}])},function(b){return c.i64.neq(d[35],void 0)?d[36]=d[35]:d[36]=c.i64.cast([0,0]),c.i64.neq(d[28],void 0)?d[37]=d[28]:d[37]=c.i64.cast([0,1]),d[33]=c.i64.neq(d[27],a[4])}]):c.resolve(d[33]=!1)},function(a){return d[14]=d[33]}]):c.resolve((d[15]=d[12].get("errors"),d[16]=d[12].get("errors"),d[14]=!1))},function(a){return d[2]=d[14]}]):c.resolve(d[2]=!1)},function(e){return d[2]?c.resolve(0):c.sequence([function(e){return d[9]=a[3].get("request_id"),d[10]=a[3].get("reference_timestamp"),d[11]=a[3].get("restore_task_source"),d[12]=a[3].get("restore_operation_type"),c.i64.neq(a[4],void 0)?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[25]=new c.Map(),d[25].set("error_msg","Expected a nonempty query result"),d[25].set("code",c.i64.cast([0,3])),d[25].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[26]=c.createArray(),d[27]=(d[26].push(d[25]),d[26]),e=[void 0,d[26]],d[19]=e[0],d[20]=e[1],e):(b=a.item,d[25]=new c.Map(),d[25].set("backup_id",b.backupId),d[25].set("device_public_key_blob",b.devicePublicKeyBlob),d[25].set("device_private_key_blob",b.devicePrivateKeyBlob),d[25].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[25].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[25].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[25].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[25].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[25].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[25].set("orf_client_state_v2_blob",void 0),d[25].set("orf_v2_authority_level",void 0),d[25].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[25].set("device_id",b.deviceId),d[25].set("backup_tenancy",b.backupTenancy),d[25].set("encryption_version",b.encryptionVersion),d[25].set("revision_version",b.revisionVersion),d[25].set("initialize_restore_result",void 0),d[25].set("authority_level",b.authorityLevel),e=[d[25],void 0],d[19]=e[0],d[20]=e[1],e)})},function(e){return d[22]=new c.Map(),d[22].set("value",d[19]),d[22].set("errors",d[20]),d[23]=d[22].get("value"),d[23]!==void 0?c.sequence([function(e){return d[25]=d[23].get("backup_id"),d[26]=d[23].get("device_public_key_blob"),d[27]=d[23].get("device_private_key_blob"),d[28]=d[23].get("epoch_storage_public_key_blob"),d[29]=d[23].get("epoch_storage_private_key_blob"),d[30]=d[23].get("epoch_auth_public_key_blob"),d[31]=d[23].get("epoch_auth_private_key_blob"),d[32]=d[23].get("mailbox_root_key_blob"),d[33]=d[23].get("ocmf_client_state_blob"),d[34]=d[23].get("orf_client_state_v2_blob"),d[35]=d[23].get("orf_v2_authority_level"),d[36]=d[23].get("oblivious_validation_token_blob"),d[37]=d[23].get("device_id"),d[38]=d[23].get("backup_tenancy"),d[39]=d[23].get("encryption_version"),d[40]=d[23].get("revision_version"),d[41]=d[23].get("initialize_restore_result"),d[42]=d[23].get("authority_level"),c.i64.neq(d[37],void 0)?c.sequence([function(a){return d[44]=void 0,c.i64.neq(d[44],void 0)?c.resolve(d[45]=d[44]):c.sequence([function(a){return d[48]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[58]=(d[48].push(c.i64.cast([0,0])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[58]=(d[48].push(c.i64.cast([0,2])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[58]=(d[48].push(c.i64.cast([0,3])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[58]=(d[48].push(c.i64.cast([0,4])),d[48]):0,d[53]=c.createArray(),d[54]=c.i64.of_int32(d[48].length),c.i64.gt(d[54],c.i64.cast([0,0]))?c.loopAsync(d[54],function(a){return d[58]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[48],d[58]).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return d[61]=(d[53].push(d[59]),d[53])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[58]=c.createArray(),d[59]=c.i64.of_int32(d[53].length),c.i64.gt(d[59],c.i64.cast([0,0]))?c.loopAsync(d[59],function(a){return d[61]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],d[61]).then(function(a){return a=a,d[62]=a[0],d[63]=a[1],a})},function(a){return d[64]=(d[58].push(c.i64.to_string(d[62])),d[58])}])}):c.resolve()},function(a){return d[60]=d[58].join(","),d[55]=d[60]}])},function(a){return d[53].some(function(a){return c.i64.eq(d[39],a)})?d[56]=d[39]:d[56]=void 0,c.i64.neq(d[56],void 0)?d[57]=d[56]:d[57]=void 0,d[45]=d[57]}])},function(b){return c.i64.neq(d[45],void 0)?d[46]=d[45]:d[46]=c.i64.cast([0,0]),c.i64.neq(d[38],void 0)?d[47]=d[38]:d[47]=c.i64.cast([0,1]),d[43]=c.i64.neq(d[37],a[4])}]):c.resolve(d[43]=!1)},function(a){return d[24]=d[43]}]):c.resolve((d[25]=d[22].get("errors"),d[26]=d[22].get("errors"),d[24]=!1))},function(a){return d[13]=d[24]}]):c.resolve(d[13]=!1)},function(e){return d[13]?c.resolve((d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,110])),d[19].set("stored_procedure","LSEncryptedBackupsHandleFTSIndexMessageResponseStoredProcedure"),d[19].set("error_message",""),d[14]=d[19])):c.sequence([function(e){return c.storedProcedure(b("LSDecryptMessages"),a[0],a[2]).then(function(a){return a=a,d[19]=a[0],d[20]=a[1],a})},function(e){return d[19]!==void 0?c.sequence([function(a){return d[22]=c.createArray(),d[23]=c.i64.of_int32(d[19].length),c.i64.gt(d[23],c.i64.cast([0,0]))?c.loopAsync(d[23],function(a){return d[32]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[19],d[32]).then(function(a){return a=a,d[33]=a[0],d[34]=a[1],a})},function(a){return d[35]=d[33].get("value"),d[36]=(d[22].push(d[35]),d[22])}])}):c.resolve()},function(e){return d[24]=a[1].get("has_more_before"),d[25]=a[1].get("next_message_timestamp_ms_before"),d[26]=a[1].get("has_more_after"),d[27]=a[1].get("next_message_timestamp_ms_after"),c.nativeOperation(b("LSRestoreEchoBlobs.nop"),c.i64.cast([0,0]),d[22],d[24],d[25],d[26],d[27],!1,a[2],d[9],d[10],d[11],void 0).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],d[30]=a[2],a})},function(a){return d[28]?d[31]=void 0:(d[32]=new c.Map(),d[32].set("error_code",c.i64.cast([0,105])),d[32].set("stored_procedure","LSEncryptedBackupsHandleFTSIndexMessageResponseStoredProcedure"),d[32].set("error_message",""),d[31]=d[32]),d[21]=d[31]}]):c.resolve(d[21]=d[20])},function(a){return d[14]=d[21]}])},function(e){return d[14]!==void 0?c.sequence([function(e){return d[19]=d[14].get("error_code"),d[20]=d[14].get("stored_procedure"),d[21]=new c.Map(),d[21].set("error_code",d[19]),d[21].set("error_message",void 0==null?"":void 0),d[21].set("stored_procedure",d[20]),d[22]=new c.Map(),d[22].set("act_thread_id",a[2]),d[22].set("source",d[11]),d[22].set("restore_operation_type",d[12]),d[22].set("request_id",void 0),d[22].set("device_id",void 0),d[23]=new c.Map(),d[23].set("restore_context",d[22]),d[23].set("failure",d[21]),d[24]=d[23].get("queue_name"),d[24]!==void 0?d[25]=d[24]:(d[30]=d[23].get("restore_context"),d[31]=d[30].get("act_thread_id"),d[25]=["encrypted_backups_restore",":",d[31]].join("")),d[26]=c.toJSON(d[23]),c.storedProcedure(b("LSIssueNewTask"),d[25],c.i64.cast([0,50030]),d[26],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[27]=d[14].get("error_code"),d[28]=d[14].get("error_code"),d[29]=" ",d[15]=["Failed (",d[29],c.i64.to_string(d[28]),d[29],")"].join("")}]):c.resolve(d[15]="Succeeded")},function(e){return d[16]="",d[17]=["Message Restore Status: ",d[16],d[15],d[16],". ACT Thread ID: ",d[16],a[2]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleFTSIndexMessageResponse] ","",d[17]].join("")),d[18]=c.createArray(),void 0!==void 0?d[19]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleFTSIndexMessageResponse",[d[17]].join(""),d[18],c.i64.cast([0,4]))}])},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleFTSIndexMessageResponse] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleFTSIndexMessageResponse",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleFTSIndexMessageResponseStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);